# Supabase Schema for BoatNode

Based on the requirements, here is the proposed database schema for Supabase.

## Tables

### `users`
Stores user information.

| Column | Type | Constraints | Description |
|---|---|---|---|
| `id` | `bigint` | `primary key`, `generated by default as identity` | Unique user ID (numeric as per device requirement). |
| `phone_number` | `text` | `unique`, `not null` | User's phone number. |
| `display_name` | `text` | `not null` | User's display name (UTF-8, max 12 bytes recommended). |
| `created_at` | `timestamptz` | `default now()` | Creation timestamp. |

### `boats`
Stores boat information and assignment.

| Column | Type | Constraints | Description |
|---|---|---|---|
| `id` | `text` | `primary key` | Boat ID (string, e.g., "1234"). |
| `owner_id` | `bigint` | `references users(id)` | The user who owns/paired this boat. |
| `name` | `text` | | Optional boat name (e.g., "Raja's Boat"). |
| `is_paired` | `boolean` | `default false` | Whether the boat is currently paired. |
| `created_at` | `timestamptz` | `default now()` | Creation timestamp. |

### `boat_status_logs`
Stores historical status updates from boats (via LoRaWAN or other means).

| Column | Type | Constraints | Description |
|---|---|---|---|
| `id` | `bigint` | `primary key`, `generated by default as identity` | Log ID. |
| `boat_id` | `text` | `references boats(id)` | The boat reporting the status. |
| `lat` | `double precision` | | Latitude. |
| `lon` | `double precision` | | Longitude. |
| `battery_level` | `int` | | Battery percentage. |
| `speed_cms` | `int` | | Speed in cm/s. |
| `heading_cdeg` | `int` | | Heading in centi-degrees. |
| `source` | `text` | | Source of data (e.g., 'lorawan', 'mesh'). |
| `created_at` | `timestamptz` | `default now()` | Timestamp of the log. |

## RLS Policies (Row Level Security)

- **users**:
    - `SELECT`: Public (or authenticated users only).
    - `INSERT/UPDATE`: Service role or authenticated user for their own row.
- **boats**:
    - `SELECT`: Public (or authenticated users only).
    - `UPDATE`: Authenticated user where `owner_id` matches.
- **boat_status_logs**:
    - `INSERT`: Service role (backend function or edge function receiving LoRaWAN payloads).
    - `SELECT`: Authenticated users.

## Functions / Edge Functions

- `assign_boat_id`: Function to generate or assign a new boat ID to a user.
- `handle_uplink`: Function to process incoming LoRaWAN uplinks and insert into `boat_status_logs`.
